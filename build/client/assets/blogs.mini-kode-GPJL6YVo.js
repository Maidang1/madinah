import{j as s}from"./index-BZchTVqk.js";import{u as c}from"./index-CFAftGZl.js";function n(e){const l={a:"a",code:"code",div:"div",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",span:"span",strong:"strong",ul:"ul",...c(),...e.components};return s.jsxs(s.Fragment,{children:[s.jsxs(l.h2,{id:"系统架构概览",children:["系统架构概览",s.jsx(l.a,{className:"header-anchor",href:"#系统架构概览",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.p,{children:["Mini-Kode 是一个基于 LLM 的命令行编程助手，采用 ",s.jsx(l.strong,{children:"工具调用（Tool Calling）"})," 模式与大语言模型交互。"]}),`
`,s.jsxs(l.h3,{id:"核心组件",children:["核心组件",s.jsx(l.a,{className:"header-anchor",href:"#核心组件",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                         用户界面层                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  ┌──────────────────┐              ┌──────────────────┐     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │  Interactive UI  │              │ Non-Interactive  │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │   (Ink + React)  │              │      Mode        │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  └──────────────────┘              └──────────────────┘     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                      Agent 执行引擎                           │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│              (src/agent/executor.ts)                         │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • 管理 LLM 对话循环                                          │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • 协调工具执行                                               │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • 处理权限请求                                               │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        ┌───────────────────┼───────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        ▼                   ▼                   ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌──────────────┐   ┌──────────────┐   ┌──────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  LLM Client  │   │ Tool System  │   │  Permission  │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│              │   │              │   │   System     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ • 流式响应    │   │ • 工具注册    │   │ • 权限检查    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ • Token 统计 │   │ • 并发执行    │   │ • 策略管理    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└──────────────┘   └──────────────┘   └──────────────┘"})})]})})}),`
`,s.jsxs(l.h3,{id:"技术栈",children:["技术栈",s.jsx(l.a,{className:"header-anchor",href:"#技术栈",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"TypeScript"})," - 类型安全"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"Bun"})," - 运行时和构建工具"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"Ink"})," - 基于 React 的 CLI UI"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"OpenAI SDK"})," - LLM 集成"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"Zod"})," - 运行时类型验证"]}),`
`]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"启动流程",children:["启动流程",s.jsx(l.a,{className:"header-anchor",href:"#启动流程",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"1-入口点-srcindexts",children:["1. 入口点 (",s.jsx(l.code,{children:"src/index.ts"}),")",s.jsx(l.a,{className:"header-anchor",href:"#1-入口点-srcindexts",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"#!/usr/bin/env -S node --no-warnings=ExperimentalWarning"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"import"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"EventEmitter"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"from"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"events"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#9CDCFE"},children:"EventEmitter"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"defaultMaxListeners"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#B5CEA8"},children:"200"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"; "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 支持多个 LLM 流式调用"})]}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"import"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"runCli"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"from"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"./cli"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"void"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"runCli"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"();"})]})]})})]}),`
`,s.jsxs(l.h3,{id:"2-cli-解析-srcclits",children:["2. CLI 解析 (",s.jsx(l.code,{children:"src/cli.ts"}),")",s.jsx(l.a,{className:"header-anchor",href:"#2-cli-解析-srcclits",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:"系统支持两种运行模式："}),`
`,s.jsxs(l.h4,{id:"交互模式interactive-mode",children:["交互模式（Interactive Mode）",s.jsx(l.a,{className:"header-anchor",href:"#交互模式interactive-mode",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"bash"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"# 启动交互式 UI"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"mini-kode"})})]})})]}),`
`,s.jsxs(l.h4,{id:"非交互模式non-interactive-mode",children:["非交互模式（Non-Interactive Mode）",s.jsx(l.a,{className:"header-anchor",href:"#非交互模式non-interactive-mode",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"bash"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"# 直接执行任务"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"mini-kode "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"修复 auth.ts 中的 bug"'})]})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"CLI 参数："})}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:[s.jsx(l.code,{children:"-a, --approval-mode <mode>"}),`: 权限模式
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:[s.jsx(l.code,{children:"default"}),": 每次都询问"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.code,{children:"autoEdit"}),": 自动批准文件编辑"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.code,{children:"yolo"}),": 自动批准所有操作"]}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.code,{children:"-w, --work-dir <path>"}),": 工作目录"]}),`
`]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"代码示例："})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/cli.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 非交互模式：直接执行任务"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"exitCode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"runNonInteractive"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"workDir"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"process"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"exit"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"exitCode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"} "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 交互模式：启动 UI"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"element"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"React"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"createElement"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"App"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"workDir"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" });"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"instance"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"render"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"element"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"exitOnCtrlC:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"false"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" });"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"instance"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"waitUntilExit"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"();"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"核心执行循环",children:["核心执行循环",s.jsx(l.a,{className:"header-anchor",href:"#核心执行循环",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"agent-执行引擎-srcagentexecutorts",children:["Agent 执行引擎 (",s.jsx(l.code,{children:"src/agent/executor.ts"}),")",s.jsx(l.a,{className:"header-anchor",href:"#agent-执行引擎-srcagentexecutorts",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:"这是整个系统的核心，负责管理 LLM 与工具之间的交互循环。"}),`
`,s.jsxs(l.h3,{id:"执行流程图",children:["执行流程图",s.jsx(l.a,{className:"header-anchor",href:"#执行流程图",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ 1. 用户输入 Prompt                                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ 2. 构建对话上下文                                             │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    • System Message (环境信息 + AGENTS.md)                   │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    • 历史消息                                                 │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    • 当前 Prompt                                              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ 3. 发送请求到 LLM                                             │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    • 流式响应                                                 │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    • 实时更新 UI                                              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                ┌───────────┴───────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                ▼                       ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    ┌──────────────────┐    ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    │ finish_reason:   │    │ finish_reason:   │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'    │   "stop"         │    │  "tool_calls"    │'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    └──────────────────┘    └──────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                │                       │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                ▼                       ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    ┌──────────────────┐    ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    │ 返回最终响应      │    │ 执行工具调用      │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"    └──────────────────┘    └──────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                        ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │ 工具执行完成      │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │ 添加结果到对话    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            └──────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                        ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │ 回到步骤 3        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │ (继续循环)        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            └──────────────────┘"})})]})})}),`
`,s.jsxs(l.h3,{id:"核心代码解析",children:["核心代码解析",s.jsx(l.a,{className:"header-anchor",href:"#核心代码解析",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/executor.ts - executeAgent 函数"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"export"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeAgent"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionCallbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {},"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Promise"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"<"}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionResult"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"> {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 1. 初始化 LLM 客户端"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"client"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"createClient"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({ "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" });"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 2. 构建对话历史"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"systemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"buildSystemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"let"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ChatCompletionMessageParam"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"[] = ["})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"systemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    ..."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"toOpenAIMessages"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"session"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"messages"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"),"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"user"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  ];"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3. 主循环"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"while"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3.1 流式调用 LLM"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"stream"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"streamChatCompletion"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"client"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"signal"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tools:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"openaiTools"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    });"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3.2 处理流式响应"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"for"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"response"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"of"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"stream"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"onLLMMessageUpdate"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?.({"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"kind:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"api"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"response"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"isComplete"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ? "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"complete"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" : "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"streaming"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"response"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"completeMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      });"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3.3 判断 finish_reason"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"finishReason"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool_calls"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" && "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"parsedCalls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"length"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" > "}),s.jsx(l.span,{style:{color:"#B5CEA8"},children:"0"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 执行工具"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"toolCalls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeToolsWithPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"parsedCalls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      );"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 添加工具结果到对话"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"for"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"of"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCalls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"toolMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"formatToolResultMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"push"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 继续循环"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"continue"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3.4 返回最终响应"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"success:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"response:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"assembled"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsxs(l.h3,{id:"系统消息构建",children:["系统消息构建",s.jsx(l.a,{className:"header-anchor",href:"#系统消息构建",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:"系统消息包含环境信息和项目上下文："}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/context.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"buildSystemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"effectiveCwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"envInfo"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"EnvironmentInfo"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"effectiveCwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"isGitRepo:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"isGitRepository"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"effectiveCwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"),"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"platform:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"process"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"platform"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"date:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"new"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Date"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"()."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"toISOString"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"()."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"split"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"T"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:")["}),s.jsx(l.span,{style:{color:"#B5CEA8"},children:"0"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"],"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"model:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"client"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"model"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  };"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 读取 AGENTS.md 作为项目上下文"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"let"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"projectContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'""'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"agentsPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"join"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"envInfo"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"AGENTS.md"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"fs"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"existsSync"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"agentsPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:")) {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"projectContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"fs"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"readFileSync"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"agentsPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"utf8"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"system"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"buildSystemPrompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"envDetails"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"projectContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"AGENTS.md 的作用："})}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"提供项目特定的上下文信息"}),`
`,s.jsx(l.li,{children:"记录技术栈、架构、开发规范"}),`
`,s.jsx(l.li,{children:"帮助 LLM 更好地理解项目"}),`
`]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"工具执行机制",children:["工具执行机制",s.jsx(l.a,{className:"header-anchor",href:"#工具执行机制",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"工具系统架构",children:["工具系统架构",s.jsx(l.a,{className:"header-anchor",href:"#工具系统架构",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                      Tool Definition                         │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • name: 工具名称                                             │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • description: 工具描述                                      │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • inputSchema: Zod 验证模式                                  │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • readonly: 是否只读                                         │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • execute: 执行函数                                          │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                   Tool Executor                              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│              (src/agent/toolExecutor.ts)                     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        ┌───────────────────┼───────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        ▼                   ▼                   ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌──────────────┐   ┌──────────────┐   ┌──────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  Concurrent  │   │  Sequential  │   │  Permission  │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  Execution   │   │  Execution   │   │   Handling   │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  (只读工具)   │   │  (写入工具)   │   │              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└──────────────┘   └──────────────┘   └──────────────┘"})})]})})}),`
`,s.jsxs(l.h3,{id:"并发执行策略",children:["并发执行策略",s.jsx(l.a,{className:"header-anchor",href:"#并发执行策略",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/toolExecutor.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeToolsWithPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"calls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ParsedToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"[],"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionCallbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Promise"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"<"}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"[]> {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 检查是否所有工具都是只读的"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"allReadonly"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallsToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"every"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"(("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tc"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"=>"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"tool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolsByName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tc"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"];"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"readonly"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  });"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"allReadonly"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 并发执行只读工具"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeToolsConcurrently"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallsToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 顺序执行包含写入操作的工具"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeToolsSequentially"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallsToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"为什么需要区分并发和顺序执行？"})}),`
`,s.jsxs(l.ol,{children:[`
`,s.jsxs(l.li,{children:[`
`,s.jsxs(l.p,{children:[s.jsx(l.strong,{children:"只读工具（Concurrent）"}),"："]}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:["例如：",s.jsx(l.code,{children:"fileRead"}),", ",s.jsx(l.code,{children:"grepSearch"})]}),`
`,s.jsx(l.li,{children:"无副作用，可以并发执行提高性能"}),`
`,s.jsx(l.li,{children:"结果按照调用顺序返回"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsxs(l.p,{children:[s.jsx(l.strong,{children:"写入工具（Sequential）"}),"："]}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:["例如：",s.jsx(l.code,{children:"fsWrite"}),", ",s.jsx(l.code,{children:"bash"})]}),`
`,s.jsx(l.li,{children:"有副作用，必须顺序执行避免冲突"}),`
`,s.jsx(l.li,{children:"确保操作的原子性"}),`
`]}),`
`]}),`
`]}),`
`,s.jsxs(l.h3,{id:"工具执行流程",children:["工具执行流程",s.jsx(l.a,{className:"header-anchor",href:"#工具执行流程",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/tools/runner.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeSingleTool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"execContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolExecutionContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"startedAt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Promise"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"<"}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"> {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"try"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"tool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolsByName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"];"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"execute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"input"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"execContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 检查是否是业务逻辑错误"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"isError"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"in"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" && "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"isError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        ..."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      ..."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"success"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    };"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"catch"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 捕获权限错误"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"instanceof"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"PermissionRequiredError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        ..."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"permission_required"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"uiHint:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"uiHint"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      ..."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"isError:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"String"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") },"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"权限系统",children:["权限系统",s.jsx(l.a,{className:"header-anchor",href:"#权限系统",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"权限架构",children:["权限架构",s.jsx(l.a,{className:"header-anchor",href:"#权限架构",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.p,{children:["Mini-Kode 实现了",s.jsx(l.strong,{children:"两层权限系统"}),"："]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                      Approval Mode                           │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • yolo: 自动批准所有操作                                     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • autoEdit: 自动批准文件编辑                                 │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  • default: 每次都询问                                        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│                   Permission Policies                        │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  ┌──────────────────┐              ┌──────────────────┐     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │  Project Policy  │              │ Session Policy   │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │  (持久化到磁盘)   │              │  (内存中)         │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │  .mini-kode/     │              │  运行时授权       │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  │  config.json     │              │                  │     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│  └──────────────────┘              └──────────────────┘     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})})]})})}),`
`,s.jsxs(l.h3,{id:"权限检查流程",children:["权限检查流程",s.jsx(l.a,{className:"header-anchor",href:"#权限检查流程",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/permissions/policyResolver.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"export"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"checkFsPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"targetPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ApprovalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" } | { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"false"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"; "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" } {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 1. YOLO 模式：自动批准"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"yolo"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 2. AutoEdit 模式：自动批准写操作"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"autoEdit"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3. 检查 Session 权限（内存，快速）"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"checkSessionFsPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"targetPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:")) {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 4. 检查 Project 权限（磁盘，持久化）"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"checkProjectFsPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"targetPath"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:")) {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" };"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 5. 需要用户授权"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"ok:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"false"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`Permission required to modify: "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"${"}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"relativePath"}),s.jsx(l.span,{style:{color:"#569CD6"},children:"}"}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsxs(l.h3,{id:"权限类型",children:["权限类型",s.jsx(l.a,{className:"header-anchor",href:"#权限类型",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.ol,{children:[`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"文件系统权限（FS）"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"FsGrant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"fs"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"; "}),s.jsx(l.span,{style:{color:"#6A9955"},children:'// 绝对路径或 "*" 表示全局'})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})})]})})]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Bash 命令权限"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"BashGrant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"bash"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"command"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"; "}),s.jsx(l.span,{style:{color:"#6A9955"},children:'// 命令或 "npm:*" 表示前缀匹配'})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})})]})})]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"MCP 工具权限"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"MCPGrant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"mcp"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"serverName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolName"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?: "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"; "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 可选，特定工具"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})})]})})]}),`
`]}),`
`]}),`
`,s.jsxs(l.h3,{id:"异步权限请求流程",children:["异步权限请求流程",s.jsx(l.a,{className:"header-anchor",href:"#异步权限请求流程",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"┌─────────────────────────────────────────────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│ 1. 工具执行时检查权限                                         │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"│    checkFsPermission() / checkBashApproval()                │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"└─────────────────────────────────────────────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                            ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                    ┌───────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                    │ 权限已授予？   │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                    └───────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                    │               │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                Yes │               │ No"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                    ▼               ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        ┌──────────────┐   ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        │ 直接执行      │   │ 抛出              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        │              │   │ PermissionRequired│"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        │              │   │ Error             │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"        └──────────────┘   └──────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                    ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        ┌──────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │ Executor 捕获错误     │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │ 调用 onPermission    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │ Required 回调         │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        └──────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                    ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        ┌──────────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │ UI 显示权限请求       │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │ 等待用户决策          │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        └──────────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                                    │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        ┌───────────┴───────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        ▼                       ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            ┌──────────────────┐    ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            │ 用户批准          │    │ 用户拒绝          │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            └──────────────────┘    └──────────────────┘"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        │                       │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"                        ▼                       ▼"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            ┌──────────────────┐    ┌──────────────────┐"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            │ 应用授权并重新    │    │ 返回              │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            │ 执行工具          │    │ permission_denied │"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"            └──────────────────┘    └──────────────────┘"})})]})})}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"代码示例："})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/toolExecutor.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeSingleToolWithPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCallPending"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionCallbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Promise"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"<"}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"> {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 执行工具"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeSingleToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"permission_required"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 处理权限请求"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"finalResult"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"handlePermissionRequest"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    );"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"finalResult"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"async"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"handlePermissionRequest"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCallPermissionRequired"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolExecutionContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionCallbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"Promise"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"<"}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"> {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 调用回调，等待用户决策"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"decision"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"onPermissionRequired"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?.("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"uiHint"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"requestId"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  );"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"decision"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"approved"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 应用授权"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"applyPermissionGrant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"decision"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"grant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 重新执行工具"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeSingleToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolContext"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 用户拒绝"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      ..."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolCallToExecute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"permission_denied"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"isError:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"Permission denied by user"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"消息流转",children:["消息流转",s.jsx(l.a,{className:"header-anchor",href:"#消息流转",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"openai-消息顺序规则",children:["OpenAI 消息顺序规则",s.jsx(l.a,{className:"header-anchor",href:"#openai-消息顺序规则",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.p,{children:["OpenAI API 对消息顺序有",s.jsx(l.strong,{children:"严格要求"}),"，违反规则会导致 400 错误。"]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"关键规则："})}),`
`,s.jsxs(l.ol,{children:[`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Tool 消息必须跟在包含 tool_calls 的 Assistant 消息后面"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// ✅ 正确"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"user"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_calls:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" [{ "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", ... }] },"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"]"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// ❌ 错误"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"user"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 没有前置 tool_calls"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"]"})})]})})]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"每个 tool_call 必须有且仅有一个对应的 tool 消息"})}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Tool 消息必须按照 tool_calls 数组的顺序"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// ✅ 正确"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_calls:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" [{ "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }] },"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 第一个"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 第二个"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"]"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// ❌ 错误（顺序颠倒）"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"["})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_calls:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" [{ "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }] },"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 顺序错误"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"..."'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"]"})})]})})]}),`
`]}),`
`]}),`
`,s.jsxs(l.h3,{id:"消息格式化",children:["消息格式化",s.jsx(l.a,{className:"header-anchor",href:"#消息格式化",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/formatters.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"export"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"function"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"formatToolResultMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ToolCall"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"): "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ChatCompletionToolMessageParam"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"let"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"success"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"JSON"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"stringify"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"null"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#B5CEA8"},children:"2"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`Error: "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"${"}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message"}),s.jsx(l.span,{style:{color:"#569CD6"},children:"}"}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"abort"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" === "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"permission_denied"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`"}),s.jsx(l.span,{style:{color:"#569CD6"},children:"${"}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"toolName"}),s.jsx(l.span,{style:{color:"#569CD6"},children:"}"}),s.jsx(l.span,{style:{color:"#CE9178"},children:" was rejected by user`"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"requestId"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsxs(l.h3,{id:"典型消息流",children:["典型消息流",s.jsx(l.a,{className:"header-anchor",href:"#典型消息流",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"Round 1: 简单工具调用"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'1. user: "读取 file.txt"'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'2. assistant: { tool_calls: [{ id: "call_1", function: "fileRead" }] }'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'3. tool: { tool_call_id: "call_1", content: "{ 文件内容 }" }'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'4. assistant: "文件包含..."'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"}})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"Round 2: 多工具调用"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'5. user: "比较 file1.txt 和 file2.txt"'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"6. assistant: { tool_calls: ["})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'     { id: "call_2", function: "fileRead", arguments: "file1.txt" },'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'     { id: "call_3", function: "fileRead", arguments: "file2.txt" }'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:"   ]}"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'7. tool: { tool_call_id: "call_2", content: "{ file1 内容 }" }'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'8. tool: { tool_call_id: "call_3", content: "{ file2 内容 }" }'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"undefined"},children:'9. assistant: "比较结果..."'})})]})})}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"错误处理",children:["错误处理",s.jsx(l.a,{className:"header-anchor",href:"#错误处理",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.h3,{id:"错误分类",children:["错误分类",s.jsx(l.a,{className:"header-anchor",href:"#错误分类",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/types.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"ExecutionError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"type"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:":"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"permission_denied"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 用户拒绝权限 (exit 1)"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"aborted"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"            "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 用户取消 (exit 3)"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"llm_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"          "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// LLM API 错误 (exit 2)"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"internal_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 内部错误 (exit 4)"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"string"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cause"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?: "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"unknown"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})})]})})]}),`
`,s.jsxs(l.h3,{id:"错误处理流程",children:["错误处理流程",s.jsx(l.a,{className:"header-anchor",href:"#错误处理流程",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// src/agent/executor.ts"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"try"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 执行循环"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"while"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// LLM 调用和工具执行"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"} "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"catch"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 1. 错误分类"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"let"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorType"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"aborted"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"llm_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" | "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"internal_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"internal_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"instanceof"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"APIUserAbortError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorType"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"aborted"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  } "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"else"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"instanceof"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"OpenAIError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorType"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"llm_error"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 2. 更新 UI 状态"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"onGeneratingChange"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?.("}),s.jsx(l.span,{style:{color:"#569CD6"},children:"false"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 3. 调用错误回调（用户取消除外）"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"if"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" ("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorType"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" !== "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"aborted"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:") {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"onError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"?.("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line"}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#6A9955"},children:"// 4. 返回错误结果"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"success:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"false"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"error:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"type:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorType"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"errorMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cause:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"err"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" },"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  };"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsxs(l.h3,{id:"常见错误场景",children:["常见错误场景",s.jsx(l.a,{className:"header-anchor",href:"#常见错误场景",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsxs(l.ol,{children:[`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"LLM API 错误"})}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"速率限制（Rate Limit）"}),`
`,s.jsx(l.li,{children:"认证失败（Authentication）"}),`
`,s.jsx(l.li,{children:"网络错误（Network）"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"工具执行错误"})}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"文件不存在"}),`
`,s.jsx(l.li,{children:"命令执行失败"}),`
`,s.jsx(l.li,{children:"权限不足"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"用户中断"})}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"Ctrl+C 取消"}),`
`,s.jsx(l.li,{children:"拒绝权限请求"}),`
`]}),`
`]}),`
`]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"完整执行示例",children:["完整执行示例",s.jsx(l.a,{className:"header-anchor",href:"#完整执行示例",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:"让我们通过一个完整的例子来理解整个流程："}),`
`,s.jsxs(l.h3,{id:"场景修改文件",children:["场景：修改文件",s.jsx(l.a,{className:"header-anchor",href:"#场景修改文件",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"用户输入："})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"bash"}),s.jsx(l.div,{className:"code-container",children:s.jsx(l.code,{children:s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"mini-kode "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"在 src/main.ts 中添加一个 hello 函数"'})]})})})]}),`
`,s.jsxs(l.h3,{id:"执行步骤",children:["执行步骤",s.jsx(l.a,{className:"header-anchor",href:"#执行步骤",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 1: 启动和初始化"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// CLI 解析参数"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"在 src/main.ts 中添加一个 hello 函数"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"/project"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"approvalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"default"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:";"})]}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 创建 Session"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"session"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"createSession"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"();"})]}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 调用 executeAgent"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"executeAgent"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"prompt"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"signal"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"getApprovalMode"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"session"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }, "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 2: 构建对话上下文"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 系统消息"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"systemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"system"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:"`"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    Environment: macOS, /project"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    Date: 2025-11-16"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    Model: gpt-4"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    "})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    Project Context (AGENTS.md):"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    # Mini-Kode - Development Guide"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"    ..."})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#CE9178"},children:"  `"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 对话历史"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = ["})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"systemMessage"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"user"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"在 src/main.ts 中添加一个 hello 函数"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"];"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 3: LLM 第一次调用"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// LLM 决定先读取文件"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"{"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"role"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"tool_calls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": [{"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"function:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"name:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"fileRead"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"arguments:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" { "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"src/main.ts"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" }"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }]"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 4: 执行 fileRead 工具"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// fileRead 是只读工具，无需权限"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"status:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"success"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:`"export function main() { console.log('Hello'); }"`})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 添加 tool 消息到对话"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#9CDCFE"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"push"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_1"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"JSON"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"stringify"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:")"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"});"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 5: LLM 第二次调用"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// LLM 决定写入文件"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"{"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"role"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"tool_calls"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": [{"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"function:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"name:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"fsWrite"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"arguments:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"src/main.ts"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"        "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"text:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:`"export function hello() { return 'Hello'; }`}),s.jsx(l.span,{style:{color:"#D7BA7D"},children:"\\n\\n"}),s.jsx(l.span,{style:{color:"#CE9178"},children:`export function main() { console.log('Hello'); }"`})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"      }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"    }"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  }]"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 6: 执行 fsWrite 工具（需要权限）"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 检查权限"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"permission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"checkFsPermission"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"cwd"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"/project/src/main.ts"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"default"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:'// => { ok: false, message: "Permission required to modify: src/main.ts" }'})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 抛出 PermissionRequiredError"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"throw"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"new"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"PermissionRequiredError"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"kind:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"fs"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"/project/src/main.ts"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"Permission required to modify: src/main.ts"'})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"});"})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 7: 处理权限请求"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// Executor 捕获错误，调用回调"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"decision"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"callbacks"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"onPermissionRequired"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"kind:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"fs"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"path:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"/project/src/main.ts"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"message:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"Permission required to modify: src/main.ts"'})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}, "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// UI 显示权限请求，用户批准"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// decision = {"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"//   approved: true,"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:'//   grant: { type: "fs", path: "/project/src/main.ts" },'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:'//   scope: "once"'})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// }"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 应用授权到 Session Policy"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#DCDCAA"},children:"applySessionGrant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"decision"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"grant"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 重新执行工具"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#569CD6"},children:"const"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4FC1FF"},children:"result"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" = "}),s.jsx(l.span,{style:{color:"#C586C0"},children:"await"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"execute"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"("}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"input"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:", "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"context"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:");"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:'// => { status: "success" }'})})]})})]}),`
`,s.jsx(l.p,{children:s.jsx(l.strong,{children:"Step 8: LLM 第三次调用"})}),`
`,s.jsxs(l.pre,{className:"shiki dark-plus",style:{backgroundColor:"#1E1E1E",color:"#D4D4D4"},children:[s.jsx(l.div,{className:"language-id",children:"typescript"}),s.jsx(l.div,{className:"code-container",children:s.jsxs(l.code,{children:[s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 添加 tool 消息"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#9CDCFE"},children:"conversationHistory"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"push"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"role:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"tool"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"tool_call_id:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"call_2"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"content:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#4EC9B0"},children:"JSON"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"."}),s.jsx(l.span,{style:{color:"#DCDCAA"},children:"stringify"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:"({ "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"success:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" })"})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"});"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// LLM 生成最终响应"})}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"{"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"role"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"assistant"'}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#C8C8C8"},children:"content"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:": "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"我已经在 src/main.ts 中添加了 hello 函数。"'})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"}"})}),s.jsx(l.div,{className:"line"}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#6A9955"},children:"// 返回结果"})}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#C586C0"},children:"return"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" {"})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"success:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#569CD6"},children:"true"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:","})]}),s.jsxs(l.div,{className:"line",children:[s.jsx(l.span,{style:{color:"#D4D4D4"},children:"  "}),s.jsx(l.span,{style:{color:"#9CDCFE"},children:"response:"}),s.jsx(l.span,{style:{color:"#D4D4D4"},children:" "}),s.jsx(l.span,{style:{color:"#CE9178"},children:'"我已经在 src/main.ts 中添加了 hello 函数。"'})]}),s.jsx(l.div,{className:"line",children:s.jsx(l.span,{style:{color:"#D4D4D4"},children:"};"})})]})})]}),`
`,s.jsx(l.hr,{}),`
`,s.jsxs(l.h2,{id:"总结",children:["总结",s.jsx(l.a,{className:"header-anchor",href:"#总结",children:s.jsx(l.span,{className:"icon icon-link"})})]}),`
`,s.jsx(l.p,{children:"Mini-Kode 的 Agent 执行流程可以总结为："}),`
`,s.jsxs(l.ol,{children:[`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"用户输入"})," → CLI 解析 → 选择运行模式"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"Agent 初始化"})," → 构建对话上下文 → 加载 AGENTS.md"]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"LLM 循环"}),`：
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"发送请求到 LLM"}),`
`,s.jsx(l.li,{children:"流式接收响应"}),`
`,s.jsx(l.li,{children:"判断 finish_reason"}),`
`,s.jsx(l.li,{children:"如果是 tool_calls：执行工具 → 添加结果 → 继续循环"}),`
`,s.jsx(l.li,{children:"如果是 stop：返回最终响应"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"工具执行"}),`：
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"只读工具并发执行"}),`
`,s.jsx(l.li,{children:"写入工具顺序执行"}),`
`,s.jsx(l.li,{children:"权限检查和异步请求"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"权限系统"}),`：
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"Approval Mode 快速路径"}),`
`,s.jsx(l.li,{children:"Session Policy（内存）"}),`
`,s.jsx(l.li,{children:"Project Policy（持久化）"}),`
`]}),`
`]}),`
`,s.jsxs(l.li,{children:[s.jsx(l.strong,{children:"错误处理"}),`：
`,s.jsxs(l.ul,{children:[`
`,s.jsx(l.li,{children:"分类错误类型"}),`
`,s.jsx(l.li,{children:"更新 UI 状态"}),`
`,s.jsx(l.li,{children:"返回适当的退出码"}),`
`]}),`
`]}),`
`]}),`
`,s.jsx(l.p,{children:"这个架构确保了："}),`
`,s.jsxs(l.ul,{children:[`
`,s.jsxs(l.li,{children:["✅ ",s.jsx(l.strong,{children:"类型安全"}),"：TypeScript + Zod"]}),`
`,s.jsxs(l.li,{children:["✅ ",s.jsx(l.strong,{children:"高性能"}),"：并发执行只读工具"]}),`
`,s.jsxs(l.li,{children:["✅ ",s.jsx(l.strong,{children:"安全性"}),"：细粒度权限控制"]}),`
`,s.jsxs(l.li,{children:["✅ ",s.jsx(l.strong,{children:"可扩展"}),"：工具系统易于扩展"]}),`
`,s.jsxs(l.li,{children:["✅ ",s.jsx(l.strong,{children:"用户友好"}),"：流式响应和实时反馈"]}),`
`]})]})}function i(e={}){const{wrapper:l}={...c(),...e.components};return l?s.jsx(l,{...e,children:s.jsx(n,{...e})}):n(e)}export{i as default};
