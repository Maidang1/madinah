---
title: kode-cli ä¸Šä¸‹æ–‡ç®¡ç†
author: Madinah
tags:
  - AI
---

## Kode å®Œæ•´ä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹

### æ¶æ„æ¦‚è§ˆ

```plaintext
ç”¨æˆ·è¾“å…¥ â†’ REPL â†’ query() â†’ formatSystemPromptWithContext() â†’ LLM
                â†“                        â†“
            getContext()          generateSystemReminders()
                â†“                        â†“
           [é™æ€ä¸Šä¸‹æ–‡]              [åŠ¨æ€ Reminders]
```

### å®Œæ•´æ•°æ®æµç¨‹

#### 1. ç”¨æˆ·å¯åŠ¨ä¼šè¯

```typescript
// src/screens/REPL.tsx - åˆå§‹åŒ–é˜¶æ®µ

// ç”¨æˆ·å¯åŠ¨ Kode CLI
$ kode

// REPL ç»„ä»¶åˆå§‹åŒ–
const [messages, setMessages] = useState<MessageType[]>([])
const [context, setContext] = useState<{[k: string]: string}>({})

// å¼‚æ­¥åŠ è½½é™æ€ä¸Šä¸‹æ–‡ï¼ˆä¼šè¯å¼€å§‹æ—¶ä¸€æ¬¡æ€§åŠ è½½ï¼‰
useEffect(() => {
  async function loadContext() {
    const ctx = await getContext()
    setContext(ctx)
  }
  loadContext()
}, [])

```

#### 2. é™æ€ä¸Šä¸‹æ–‡æ”¶é›† (src/context.ts)

```typescript
// getContext() è¿”å›çš„æ•°æ®ç»“æ„
const staticContext = {
  // 1. ç›®å½•ç»“æ„ï¼ˆmemoizedï¼Œä¼šè¯æœŸé—´ä¸å˜ï¼‰
  directoryStructure: `
Below is a snapshot of this project's file structure:
.
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â””â”€â”€ REPL.tsx
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ claude.ts
â”‚   â”‚   â””â”€â”€ systemReminder.ts
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ TodoWriteTool/
â”‚   â”‚   â””â”€â”€ FileReadTool/
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ context.ts
â”‚       â””â”€â”€ todoStorage.ts
â”œâ”€â”€ package.json
â””â”€â”€ README.md
`,

  // 2. Git çŠ¶æ€ï¼ˆmemoizedï¼‰
  gitStatus: `
Current branch: feature/context-management
Main branch: main

Status:
M  src/services/claude.ts
M  src/query.ts
?? docs/context-flow.md

Recent commits:
abc1234 Add context management
def5678 Implement reminders
ghi9012 Fix todo storage

Your recent commits:
abc1234 Add context management
`,

  // 3. ä»£ç é£æ ¼ï¼ˆmemoizedï¼‰
  codeStyle: `
Project uses:
- TypeScript with strict mode
- React with Ink for CLI UI
- Zod for schema validation
- Prettier for formatting
`,

  // 4. README å†…å®¹
  readme: `
# Kode CLI

AI-powered coding assistant...
`,

  // 5. é¡¹ç›®æ–‡æ¡£ï¼ˆAGENTS.md + CLAUDE.mdï¼‰
  projectDocs: `
# AGENTS.md

This file provides guidance to Kode automation agents...

---

# CLAUDE.md

Additional project-specific instructions...
`,

  // 6. ç”¨æˆ·è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ï¼ˆä»é…ç½®æ–‡ä»¶ï¼‰
  customContext: `
Team conventions:
- Use functional components
- Prefer async/await over promises
`,
};
```

#### 3. ç”¨æˆ·å‘é€æ¶ˆæ¯

```typescript
// ç”¨æˆ·è¾“å…¥
const userInput = 'å¸®æˆ‘å®ç°ä¸€ä¸ªæ–°çš„ tool';

// PromptInput ç»„ä»¶å¤„ç†
const handleSubmit = async (input: string) => {
  setIsLoading(true);

  // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
  const userMessage: UserMessage = {
    type: 'user',
    uuid: crypto.randomUUID(),
    message: {
      role: 'user',
      content: input,
    },
  };

  // æ·»åŠ åˆ°æ¶ˆæ¯å†å²
  setMessages((prev) => [...prev, userMessage]);

  // å¼€å§‹æŸ¥è¯¢
  const abortController = new AbortController();
  setAbortController(abortController);

  // è°ƒç”¨ query ç”Ÿæˆå™¨
  for await (const message of query(
    [...messages, userMessage], // æ¶ˆæ¯å†å²
    getSystemPrompt(), // ç³»ç»Ÿæç¤º
    context, // é™æ€ä¸Šä¸‹æ–‡
    canUseTool, // æƒé™æ£€æŸ¥å‡½æ•°
    {
      abortController,
      options: {
        commands,
        forkNumber,
        messageLogName,
        tools,
        verbose,
        safeMode,
        maxThinkingTokens: getMaxThinkingTokens(),
        model: 'main',
      },
      readFileTimestamps: {},
      setToolJSX,
      agentId: 'default',
    },
    getBinaryFeedbackResponse,
  )) {
    setMessages((prev) => [...prev, message]);
  }

  setIsLoading(false);
};
```

#### 4. query() å‡½æ•°å¤„ç† (src/query.ts)

```typescript
export async function* query(
  messages: Message[],
  systemPrompt: string[],
  context: { [k: string]: string },
  canUseTool: CanUseToolFn,
  toolUseContext: ExtendedToolUseContext,
  getBinaryFeedbackResponse?: (m1, m2) => Promise<BinaryFeedbackResult>,
): AsyncGenerator<Message, void> {
  // ğŸ“Š å½“å‰çŠ¶æ€
  console.log('=== Query Start ===');
  console.log('Messages count:', messages.length);
  console.log('Context keys:', Object.keys(context));
  console.log('Agent ID:', toolUseContext.agentId);

  // ğŸ”„ è‡ªåŠ¨å‹ç¼©æ£€æŸ¥
  const { messages: processedMessages, wasCompacted } = await checkAutoCompact(
    messages,
    toolUseContext,
  );

  if (wasCompacted) {
    console.log(
      'âœ… Messages compacted:',
      messages.length,
      'â†’',
      processedMessages.length,
    );
    messages = processedMessages;
  }

  // ğŸ¯ æ ¼å¼åŒ–ç³»ç»Ÿæç¤º + ç”ŸæˆåŠ¨æ€ reminders
  const { systemPrompt: fullSystemPrompt, reminders } =
    formatSystemPromptWithContext(
      systemPrompt,
      context,
      toolUseContext.agentId,
    );

  console.log('System prompt blocks:', fullSystemPrompt.length);
  console.log('Reminders generated:', reminders ? 'Yes' : 'No');

  // ğŸ“¢ è§¦å‘ä¼šè¯å¯åŠ¨äº‹ä»¶
  emitReminderEvent('session:startup', {
    agentId: toolUseContext.agentId,
    messages: messages.length,
    timestamp: Date.now(),
  });

  // ğŸ’‰ æ³¨å…¥ reminders åˆ°æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
  if (reminders && messages.length > 0) {
    for (let i = messages.length - 1; i >= 0; i--) {
      if (messages[i]?.type === 'user') {
        const lastUserMessage = messages[i] as UserMessage;

        // å‰ç½®æ³¨å…¥ reminders
        messages[i] = {
          ...lastUserMessage,
          message: {
            ...lastUserMessage.message,
            content: reminders + lastUserMessage.message.content,
          },
        };

        console.log('âœ… Reminders injected to message', i);
        break;
      }
    }
  }

  // ğŸ¤– è°ƒç”¨ LLM
  const result = await queryWithBinaryFeedback(
    toolUseContext,
    () =>
      queryLLM(
        normalizeMessagesForAPI(messages),
        fullSystemPrompt,
        toolUseContext.options.maxThinkingTokens,
        toolUseContext.options.tools,
        toolUseContext.abortController.signal,
        {
          safeMode: toolUseContext.options.safeMode,
          model: toolUseContext.options.model || 'main',
          prependCLISysprompt: true,
          toolUseContext,
        },
      ),
    getBinaryFeedbackResponse,
  );

  // è¿”å› AI å“åº”
  if (result.message) {
    yield result.message;
  }

  // ğŸ”§ å¤„ç†å·¥å…·è°ƒç”¨...
  // ï¼ˆçœç•¥å·¥å…·æ‰§è¡Œé€»è¾‘ï¼‰
}
```

#### 5. formatSystemPromptWithContext() (src/services/claude.ts)

```typescript
export function formatSystemPromptWithContext(
  systemPrompt: string[],
  context: { [k: string]: string },
  agentId?: string,
  skipContextReminders = false,
): { systemPrompt: string[]; reminders: string } {
  const enhancedPrompt = [...systemPrompt];
  let reminders = '';

  // ğŸ“Š è¾“å…¥æ•°æ®ç¤ºä¾‹
  console.log('=== formatSystemPromptWithContext ===');
  console.log('Input systemPrompt:', systemPrompt.slice(0, 2));
  console.log('Input context keys:', Object.keys(context));
  console.log('Agent ID:', agentId);

  // ğŸ¯ æ­¥éª¤ 0: GPT-5 ç‰¹æ®Šå¤„ç†
  const modelManager = getModelManager();
  const modelProfile = modelManager.getModel('main');

  if (modelProfile && isGPT5Model(modelProfile.modelName)) {
    enhancedPrompt.push(
      '\n# Agent Persistence for Long-Running Coding Tasks',
      'You are working on a coding project...',
      // ... æ›´å¤šæŒä¹…åŒ–æŒ‡ä»¤
    );
    console.log('âœ… Added GPT-5 persistence prompts');
  }

  // ğŸ” æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¸‹æ–‡
  const hasContext = Object.entries(context).length > 0;
  console.log('Has context:', hasContext);

  if (hasContext) {
    // ğŸ“„ æ­¥éª¤ 1: æ³¨å…¥ Kode é¡¹ç›®æ–‡æ¡£åˆ°ç³»ç»Ÿæç¤º
    if (!skipContextReminders) {
      const kodeContext = generateKodeContext();

      if (kodeContext) {
        enhancedPrompt.push('\n---\n# é¡¹ç›®ä¸Šä¸‹æ–‡\n');
        enhancedPrompt.push(kodeContext);
        enhancedPrompt.push('\n---\n');

        console.log('âœ… Kode context injected:', kodeContext.length, 'chars');
      }
    }

    // ğŸ”” æ­¥éª¤ 2: ç”ŸæˆåŠ¨æ€ reminders
    const reminderMessages = generateSystemReminders(hasContext, agentId);

    if (reminderMessages.length > 0) {
      reminders = reminderMessages.map((r) => r.content).join('\n') + '\n';

      console.log('âœ… Generated reminders:', reminderMessages.length);
      console.log(
        'Reminder types:',
        reminderMessages.map((r) => r.type).join(', '),
      );
    }

    // ğŸ“¦ æ­¥éª¤ 3: æ·»åŠ å…¶ä»–é™æ€ä¸Šä¸‹æ–‡
    enhancedPrompt.push(
      `\nAs you answer the user's questions, you can use the following context:\n`,
    );

    // è¿‡æ»¤æ‰å·²å¤„ç†çš„é¡¹ç›®æ–‡æ¡£
    const filteredContext = Object.fromEntries(
      Object.entries(context).filter(
        ([key]) => key !== 'projectDocs' && key !== 'userDocs',
      ),
    );

    enhancedPrompt.push(
      ...Object.entries(filteredContext).map(
        ([key, value]) => `<context name="${key}">${value}</context>`,
      ),
    );

    console.log(
      'âœ… Added context blocks:',
      Object.keys(filteredContext).join(', '),
    );
  }

  // ğŸ“¤ è¾“å‡ºæ•°æ®ç¤ºä¾‹
  console.log('=== Output ===');
  console.log('Enhanced prompt blocks:', enhancedPrompt.length);
  console.log('Reminders length:', reminders.length);

  return { systemPrompt: enhancedPrompt, reminders };
}
```

#### 6. generateSystemReminders() (src/services/systemReminder.ts)

```typescript
public generateReminders(
  hasContext: boolean = false,
  agentId?: string
): ReminderMessage[] {

  console.log('=== generateSystemReminders ===')
  console.log('Has context:', hasContext)
  console.log('Agent ID:', agentId)

  // ğŸš« æ— ä¸Šä¸‹æ–‡æ—¶ä¸ç”Ÿæˆ
  if (!hasContext) {
    console.log('âŒ No context, skipping reminders')
    return []
  }

  // ğŸš« è¾¾åˆ°ä¼šè¯é™åˆ¶
  if (this.sessionState.reminderCount >=
      this.sessionState.config.maxRemindersPerSession) {
    console.log('âŒ Reminder limit reached:',
      this.sessionState.reminderCount)
    return []
  }

  const reminders: ReminderMessage[] = []

  // ğŸ”„ æ‡’åŠ è½½ç”Ÿæˆå™¨
  const reminderGenerators = [
    () => this.dispatchTodoEvent(agentId),
    () => this.dispatchSecurityEvent(),
    () => this.dispatchPerformanceEvent(),
    () => this.getMentionReminders()
  ]

  for (const generator of reminderGenerators) {
    if (reminders.length >= 5) break

    const result = generator()
    if (result) {
      const remindersToAdd = Array.isArray(result) ? result : [result]
      reminders.push(...remindersToAdd)
      this.sessionState.reminderCount += remindersToAdd.length

      console.log('âœ… Added reminder:',
        remindersToAdd.map(r => r.type).join(', '))
    }
  }

  console.log('=== Total reminders ===', reminders.length)

  return reminders
}

// Todo Reminder ç¤ºä¾‹
private dispatchTodoEvent(agentId?: string): ReminderMessage | null {
  const todos = getTodos(agentId)
  const agentKey = agentId || 'default'

  console.log('ğŸ“‹ Checking todos for agent:', agentKey)
  console.log('Todo count:', todos.length)

  // åœºæ™¯ 1: ç©ºåˆ—è¡¨æé†’
  if (todos.length === 0 &&
      !this.sessionState.remindersSent.has(`todo_empty_${agentKey}`)) {

    this.sessionState.remindersSent.add(`todo_empty_${agentKey}`)

    console.log('âœ… Generated empty todo reminder')

    return this.createReminderMessage(
      'todo',
      'task',
      'medium',
      'Your todo list is currently empty. Use TodoWrite if needed.',
      Date.now()
    )
  }

  // åœºæ™¯ 2: Todo æ›´æ–°æé†’
  if (todos.length > 0) {
    const stateHash = this.getTodoStateHash(todos)
    const reminderKey = `todo_updated_${agentKey}_${todos.length}_${stateHash}`

    if (!this.sessionState.remindersSent.has(reminderKey)) {
      this.sessionState.remindersSent.add(reminderKey)
      this.clearTodoReminders(agentKey)

      const todoContent = JSON.stringify(
        todos.map(todo => ({
          content: todo.content.substring(0, 100),
          status: todo.status,
          priority: todo.priority,
          id: todo.id
        }))
      )

      console.log('âœ… Generated todo update reminder')
      console.log('Todo content preview:', todoContent.substring(0, 100))

      return this.createReminderMessage(
        'todo',
        'task',
        'medium',
        `Your todo list has changed:\n${todoContent}`,
        Date.now()
      )
    }
  }

  console.log('âŒ No todo reminder needed')
  return null
}


```

#### 7. æœ€ç»ˆå‘é€ç»™ LLM çš„æ•°æ®ç»“æ„

```typescript
// queryLLM() æ¥æ”¶çš„å‚æ•°
const llmRequest = {
  // æ¶ˆæ¯å†å²ï¼ˆå·²æ³¨å…¥ remindersï¼‰
  messages: [
    {
      role: 'user',
      content: `<system-reminder>
Your todo list has changed:
[{"content":"å®ç°æ–° tool","status":"in_progress","priority":"high","id":"task-1"}]
</system-reminder>

å¸®æˆ‘å®ç°ä¸€ä¸ªæ–°çš„ tool`
    },
    {
      role: 'assistant',
      content: [
        { type: 'text', text: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ ...' },
        { type: 'tool_use', name: 'FileRead', input: {...} }
      ]
    },
    {
      role: 'user',
      content: [
        {
          type: 'tool_result',
          tool_use_id: 'toolu_123',
          content: 'æ–‡ä»¶å†…å®¹...'
        }
      ]
    }
  ],

  // ç³»ç»Ÿæç¤ºï¼ˆå·²å¢å¼ºï¼‰
  systemPrompt: [
    // åŸºç¡€ç³»ç»Ÿæç¤º
    "You are Kode, an AI coding assistant...",

    // GPT-5 æŒä¹…åŒ–æŒ‡ä»¤ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
    "\n# Agent Persistence for Long-Running Coding Tasks",
    "You are working on a coding project...",

    // Kode é¡¹ç›®æ–‡æ¡£
    "\n---\n# é¡¹ç›®ä¸Šä¸‹æ–‡\n",
    "# AGENTS.md\n\nThis file provides guidance...",
    "\n---\n",

    // é™æ€ä¸Šä¸‹æ–‡
    "\nAs you answer the user's questions, you can use the following context:\n",
    '<context name="directoryStructure">...</context>',
    '<context name="gitStatus">...</context>',
    '<context name="codeStyle">...</context>',
    '<context name="readme">...</context>'
  ],

  // å…¶ä»–å‚æ•°
  maxThinkingTokens: 10000,
  tools: [...],  // å·¥å…·å®šä¹‰
  temperature: 1.0,
  model: 'claude-sonnet-4-20250514'
}


```

### å®Œæ•´ç¤ºä¾‹ï¼šä»ç”¨æˆ·è¾“å…¥åˆ° LLM å“åº”

```typescript
// ============================================
// åœºæ™¯ï¼šç”¨æˆ·è¦æ±‚å®ç°æ–°åŠŸèƒ½
// ============================================

// 1ï¸âƒ£ ç”¨æˆ·è¾“å…¥
ç”¨æˆ·: "å¸®æˆ‘å®ç°ä¸€ä¸ªæ–‡ä»¶æœç´¢å·¥å…·"

// 2ï¸âƒ£ REPL å¤„ç†
const userMessage = {
  type: 'user',
  uuid: 'msg-001',
  message: {
    role: 'user',
    content: 'å¸®æˆ‘å®ç°ä¸€ä¸ªæ–‡ä»¶æœç´¢å·¥å…·'
  }
}

// 3ï¸âƒ£ é™æ€ä¸Šä¸‹æ–‡ï¼ˆå·²ç¼“å­˜ï¼‰
const context = {
  directoryStructure: "src/\n  tools/\n    FileReadTool/\n    ...",
  gitStatus: "Current branch: main\nStatus: clean",
  codeStyle: "TypeScript + React + Zod",
  projectDocs: "# AGENTS.md\n\nå·¥å…·å¼€å‘æŒ‡å—..."
}

// 4ï¸âƒ£ è°ƒç”¨ query()
for await (const message of query(
  [userMessage],
  ["You are Kode..."],
  context,
  canUseTool,
  toolUseContext
)) {
  // å¤„ç†å“åº”
}

// 5ï¸âƒ£ formatSystemPromptWithContext()
// è¾“å…¥:
{
  systemPrompt: ["You are Kode..."],
  context: { directoryStructure: "...", gitStatus: "...", ... },
  agentId: "default"
}

// è¾“å‡º:
{
  systemPrompt: [
    "You are Kode...",
    "\n---\n# é¡¹ç›®ä¸Šä¸‹æ–‡\n",
    "# AGENTS.md\n\nå·¥å…·å¼€å‘æŒ‡å—...",
    "\n---\n",
    "\nAs you answer...\n",
    '<context name="directoryStructure">...</context>',
    '<context name="gitStatus">...</context>'
  ],
  reminders: "<system-reminder>\nYour todo list is empty...\n</system-reminder>\n"
}

// 6ï¸âƒ£ æ³¨å…¥ reminders
messages[0].message.content =
  "<system-reminder>\nYour todo list is empty...\n</system-reminder>\n" +
  "å¸®æˆ‘å®ç°ä¸€ä¸ªæ–‡ä»¶æœç´¢å·¥å…·"

// 7ï¸âƒ£ å‘é€ç»™ LLM
API Request: {
  model: "claude-sonnet-4-20250514",
  messages: [
    {
      role: "user",
      content: "<system-reminder>...</system-reminder>\nå¸®æˆ‘å®ç°ä¸€ä¸ªæ–‡ä»¶æœç´¢å·¥å…·"
    }
  ],
  system: [
    { type: "text", text: "You are Kode..." },
    { type: "text", text: "\n---\n# é¡¹ç›®ä¸Šä¸‹æ–‡\n" },
    { type: "text", text: "# AGENTS.md\n\n..." },
    { type: "text", text: '<context name="directoryStructure">...</context>' },
    { type: "text", text: '<context name="gitStatus">...</context>',
      cache_control: { type: "ephemeral" } }  // ç¼“å­˜æ§åˆ¶
  ],
  tools: [...],
  max_tokens: 8192,
  temperature: 1.0
}

// 8ï¸âƒ£ LLM å“åº”
{
  role: "assistant",
  content: [
    {
      type: "text",
      text: "æˆ‘æ¥å¸®ä½ å®ç°ä¸€ä¸ªæ–‡ä»¶æœç´¢å·¥å…·ã€‚æ ¹æ®é¡¹ç›®ç»“æ„ï¼Œæˆ‘ä¼šåˆ›å»º..."
    },
    {
      type: "tool_use",
      name: "FileWrite",
      input: {
        path: "src/tools/FileSearchTool/FileSearchTool.tsx",
        content: "import { Tool } from '@tool'..."
      }
    }
  ]
}

// 9ï¸âƒ£ å·¥å…·æ‰§è¡Œ
// FileWrite å·¥å…·è¢«è°ƒç”¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶

// ğŸ”Ÿ è¿”å›ç»™ç”¨æˆ·
âœ… æ–‡ä»¶å·²åˆ›å»º: src/tools/FileSearchTool/FileSearchTool.tsx

```

### å…³é”®è®¾è®¡è¦ç‚¹

- é™æ€ä¸Šä¸‹æ–‡ç¼“å­˜ï¼šgetContext() ä½¿ç”¨ memoizeï¼Œä¼šè¯æœŸé—´åªåŠ è½½ä¸€æ¬¡
- åŠ¨æ€ Remindersï¼šæ¯æ¬¡æŸ¥è¯¢æ—¶å®æ—¶ç”Ÿæˆï¼ŒåŸºäºå½“å‰çŠ¶æ€
- åˆ†ç¦»æ³¨å…¥ï¼šé¡¹ç›®æ–‡æ¡£æ³¨å…¥ç³»ç»Ÿæç¤ºï¼Œreminders æ³¨å…¥ç”¨æˆ·æ¶ˆæ¯
- å»é‡æœºåˆ¶ï¼šä½¿ç”¨ remindersSent Set é¿å…é‡å¤æé†’
- ä¼˜å…ˆçº§ç®¡ç†ï¼šæœ€å¤š 5 ä¸ª remindersï¼ŒæŒ‰ä¼˜å…ˆçº§é€‰æ‹©
- ç¼“å­˜æ§åˆ¶ï¼šé•¿æ–‡æœ¬ä½¿ç”¨ prompt caching å‡å°‘æˆæœ¬
- äº‹ä»¶é©±åŠ¨ï¼šé€šè¿‡äº‹ä»¶ç³»ç»Ÿè§£è€¦å„æ¨¡å—